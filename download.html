<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Download Your Photos</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Input field for the code (hidden if code is autofilled) -->
    <input type="text" id="codeInput" placeholder="Enter your download code" style="display: none;">
    <!-- Container for photos -->
    <div id="photoContainer"></div>
    <!-- Payment container -->
    <div id="payment-container" style="display: none;">
        <form id="payment-form">
            <div id="payment-element"></div>
            <button id="buyButton">Unlock the rest: $5</button>
            <div id="payment-message"></div>
        </form>
    </div>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0VaYgD8YzgTz1V-R4Crv2noMQF0TL-Ww",
            authDomain: "sight-snap.firebaseapp.com",
            projectId: "sight-snap",
            storageBucket: "sight-snap.firebasestorage.app",
            messagingSenderId: "742529133150",
            appId: "1:742529133150:web:8ab1a667b53703c9cee2cf",
            measurementId: "G-XLDW0L2DMS"
        };
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();

        // Initialize Stripe
        const stripe = Stripe('pk_test_51QPR06DtGYmKpI3FyYGda4TaQfLsH3G9Ze3Ys29UDH6W9qWBYCTfXzFUXHMYntiCKvrW6ESN7x2kr4lj0DoUDQS500ZgLbqsbG');
        let elements;
        let photoURLs = [];
        let paymentCompleted = false;
        let currentCode = '';

        async function fetchPhotos(code) {
            currentCode = code;
            const listRef = storage.ref(`photos/${code}`);
            try {
                const res = await listRef.listAll();
                const urlPromises = res.items.map(itemRef => itemRef.getDownloadURL());
                const urls = await Promise.all(urlPromises);
                console.log('Photo URLs:', urls);
                photoURLs = urls;
                displayPhotos(photoURLs, paymentCompleted);

                if (!paymentCompleted && urls.length > 1) {
                    // Show payment container if more than one photo
                    const paymentContainer = document.getElementById('payment-container');
                    paymentContainer.style.display = 'block';

                    try {
                        // Call the Cloud Function to create payment intent
                        const response = await fetch('https://us-central1-sight-snap.cloudfunctions.net/createPaymentIntent', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        });
                        const result = await response.json();
                        if (!result.clientSecret) {
                            throw new Error('Invalid response from server');
                        }
                        const clientSecret = result.clientSecret;

                        // Initialize Stripe Elements
                        elements = stripe.elements({
                            clientSecret,
                            appearance: {
                                theme: 'stripe',
                                variables: {
                                    colorPrimary: '#28a745',
                                },
                            },
                        });
                        const paymentElement = elements.create('payment');
                        paymentElement.mount('#payment-element');

                        // Handle form submission
                        const form = document.getElementById('payment-form');
                        form.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const buyButton = document.getElementById('buyButton');
                            buyButton.disabled = true;
                            buyButton.textContent = 'Processing...';
                            try {
                                const { error, paymentIntent } = await stripe.confirmPayment({
                                    elements,
                                    confirmParams: {},
                                    redirect: 'if_required',
                                });
                                if (error) {
                                    const messageContainer = document.getElementById('payment-message');
                                    messageContainer.textContent = error.message;
                                    buyButton.disabled = false;
                                    buyButton.textContent = 'Unlock the rest: $5';
                                } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                                    paymentCompleted = true;
                                    displayPhotos(photoURLs, true);
                                    document.getElementById('payment-container').style.display = 'none';
                                } else {
                                    console.log('Payment status:', paymentIntent.status);
                                }
                            } catch (error) {
                                console.error('Error:', error);
                                const messageContainer = document.getElementById('payment-message');
                                messageContainer.textContent = 'Payment failed. Please try again.';
                                buyButton.disabled = false;
                                buyButton.textContent = 'Unlock the rest: $5';
                            }
                        });
                    } catch (error) {
                        console.error('Error setting up payment:', error);
                        document.getElementById('payment-message').textContent = 'Error setting up payment. Please try again.';
                    }
                }
            } catch (error) {
                console.error('Error fetching photos:', error);
            }
        }

        function displayPhotos(urls, showAll) {
            const photoContainer = document.getElementById('photoContainer');
            photoContainer.innerHTML = '';
            const imagesToShow = showAll ? urls : [urls[0]];
            imagesToShow.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.marginBottom = '10px';
                photoContainer.appendChild(img);
            });
        }

        window.onload = function() {
            let code = '';

            // Check if code is in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code')) {
                code = urlParams.get('code');
            } else if (localStorage.getItem('downloadCode')) {
                code = localStorage.getItem('downloadCode');
            }

            if (code) {
                // Autofill code and fetch photos
                document.getElementById('codeInput').value = code;
                document.getElementById('codeInput').style.display = 'none';
                fetchPhotos(code);
            } else {
                // Show code input field
                document.getElementById('codeInput').style.display = 'block';
                // Listen for code input
                document.getElementById('codeInput').addEventListener('change', function() {
                    const enteredCode = this.value.trim();
                    if (enteredCode) {
                        fetchPhotos(enteredCode);
                    }
                });
            }
        };
    </script>
</body>
</html>