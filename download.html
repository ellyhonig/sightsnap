<!-- download.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://maxcdn.bootstrapcdn.com https://www.gstatic.com https://js.stripe.com; style-src 'self' 'unsafe-inline' https://maxcdn.bootstrapcdn.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://www.gstatic.com; connect-src 'self' https://*.stripe.com https://*.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://firebasestorage.googleapis.com https://*.cloudfunctions.net; img-src 'self' https://firebasestorage.googleapis.com data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Download Your Photos</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        /* Your existing CSS styles */
        body {
            background-color: #f7f7f7;
        }
        .container {
            margin-top: 50px;
            max-width: 500px;
        }
        #downloadStatus {
            margin-top: 20px;
            font-weight: bold;
        }
        .btn-link {
            margin-top: 10px;
        }
        #photoContainer {
            margin-top: 20px;
        }
        #photoContainer img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        #saveInstructions {
            margin-top: 10px;
        }
        #buyButton {
            margin-top: 20px;
        }
        #payment-element {
            margin: 20px 0;
        }
        .payment-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container text-center">
        <h1>Download Your Photos</h1>
        <div id="codeInputContainer" class="mt-4">
            <input type="text" id="codeInput" class="form-control" placeholder="Enter your download code">
            <button id="downloadBtn" class="btn btn-primary mt-3">View Photos</button>
        </div>
        <p id="downloadStatus"></p>
        <div id="photoContainer" class="hidden">
            <!-- Photos will be displayed here -->
        </div>
        <div id="payment-container" class="payment-container hidden">
            <form id="payment-form">
                <div id="payment-element"></div>
                <button id="buyButton" class="btn btn-success w-100">
                    Pay $5
                </button>
                <div id="payment-message" class="mt-3 text-danger"></div>
            </form>
        </div>
        <p id="saveInstructions" class="hidden">Tap and hold the photo to save it to your Photos app.</p>
        <div class="mt-4">
            <a href="index.html" class="btn btn-link">Go to Reserve Page</a>
            <a href="photographer.html" class="btn btn-link">Go to Photographer Page</a>
        </div>
    </div>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
    <script>
        // Your Firebase configuration details
        const firebaseConfig = {
            apiKey: "AIzaSyC0VaYgD8YzgTz1V-R4Crv2noMQF0TL-Ww",
            authDomain: "sight-snap.firebaseapp.com",
            projectId: "sight-snap",
            storageBucket: "sight-snap.appspot.com",
            messagingSenderId: "742529133150",
            appId: "1:742529133150:web:8ab1a667b53703c9cee2cf",
            measurementId: "G-XLDW0L2DMS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const functions = firebase.functions();

        const stripe = Stripe('pk_test_51QPR06DtGYmKpI3FyYGda4TaQfLsH3G9Ze3Ys29UDH6W9qWBYCTfXzFUXHMYntiCKvrW6ESN7x2kr4lj0DoUDQS500ZgLbqsbG');
        let elements;
        let photoURLs = [];

        function displayPhotos(urls, showAll) {
            const photoContainer = document.getElementById('photoContainer');
            photoContainer.innerHTML = '';

            const imagesToShow = showAll ? urls : [urls[0]];

            imagesToShow.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                photoContainer.appendChild(img);
            });

            photoContainer.classList.remove('hidden');
            document.getElementById('saveInstructions').classList.remove('hidden');
        }

        async function fetchPhotos(code, showAll = false) {
            const listRef = storage.ref(`photos/${code}`);
            try {
                const res = await listRef.listAll();
                const urlPromises = res.items.map(itemRef => itemRef.getDownloadURL());
                const urls = await Promise.all(urlPromises);
                if (urls.length > 0) {
                    photoURLs = urls; // Store the URLs for later use
                    displayPhotos(urls, showAll);

                    if (!showAll) {
                        // Show payment container
                        const paymentContainer = document.getElementById('payment-container');
                        paymentContainer.classList.remove('hidden');

                        try {
                            // Call the Cloud Function using fetch
                            console.log('Calling createPaymentIntent...');
                            const response = await fetch('https://us-central1-sight-snap.cloudfunctions.net/createPaymentIntent', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                            });
                            const result = await response.json();
                            console.log('Result:', result);

                            if (!result.clientSecret) {
                                throw new Error('Invalid response from server');
                            }

                            const clientSecret = result.clientSecret;
                            console.log('Got client secret:', clientSecret);

                            // Initialize Stripe Elements with the clientSecret
                            elements = stripe.elements({
                                clientSecret,
                                appearance: {
                                    theme: 'stripe',
                                    variables: {
                                        colorPrimary: '#28a745',
                                    },
                                },
                            });

                            const paymentElement = elements.create('payment');
                            paymentElement.mount('#payment-element');

                            // Handle form submission
                            const form = document.getElementById('payment-form');
                            form.addEventListener('submit', async (e) => {
                                e.preventDefault();
                                
                                const buyButton = document.getElementById('buyButton');
                                buyButton.disabled = true;
                                buyButton.textContent = 'Processing...';

                                try {
                                    const { error, paymentIntent } = await stripe.confirmPayment({
                                        elements,
                                        confirmParams: {
                                            // Optionally pass additional parameters here
                                        },
                                        redirect: 'if_required', // Prevents automatic redirection
                                    });

                                    if (error) {
                                        const messageContainer = document.getElementById('payment-message');
                                        messageContainer.textContent = error.message;
                                        buyButton.disabled = false;
                                        buyButton.textContent = 'Pay $5';
                                    } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                                        // Payment succeeded, show all photos
                                        console.log('Payment succeeded:', paymentIntent);
                                        fetchPhotos(code, true);
                                        document.getElementById('payment-container').classList.add('hidden');
                                    } else if (paymentIntent && paymentIntent.status === 'requires_action') {
                                        // Handle additional authentication if required
                                        console.log('Payment requires additional action:', paymentIntent);
                                        // For test mode, you can simulate authentication
                                    } else {
                                        console.log('Payment status:', paymentIntent.status);
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    const messageContainer = document.getElementById('payment-message');
                                    messageContainer.textContent = 'Payment failed. Please try again.';
                                    buyButton.disabled = false;
                                    buyButton.textContent = 'Pay $5';
                                }
                            });
                        } catch (error) {
                            console.error('Detailed error:', error);
                            document.getElementById('payment-message').textContent = 
                                'Error setting up payment. Please try again.';
                        }
                    } else {
                        // Hide payment container
                        const paymentContainer = document.getElementById('payment-container');
                        paymentContainer.classList.add('hidden');
                    }
                } else {
                    document.getElementById('downloadStatus').textContent = 'No photos available for this code.';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('downloadStatus').textContent = 'Error retrieving photos.';
            }
        }

        // Combine all initialization code inside a single window.onload
        window.onload = function() {
            // Retrieve the code from localStorage
            const storedCode = localStorage.getItem('downloadCode');

            if (storedCode) {
                document.getElementById('codeInput').value = storedCode;
                localStorage.removeItem('downloadCode');
                document.getElementById('downloadBtn').click();
            }

            // Event listener for the download button
            document.getElementById('downloadBtn').addEventListener('click', function() {
                const codeInput = document.getElementById('codeInput').value.trim();
                if (codeInput) {
                    fetchPhotos(codeInput);
                    document.getElementById('codeInputContainer').classList.add('hidden');
                } else {
                    document.getElementById('downloadStatus').textContent = 'Please enter a valid code.';
                }
            });

            // Check if code is passed in URL
            const urlParams = new URLSearchParams(window.location.search);
            const codeFromURL = urlParams.get('code');
            if (codeFromURL) {
                fetchPhotos(codeFromURL);
                document.getElementById('codeInputContainer').classList.add('hidden');
            }
        };
    </script>
</body>
</html>
